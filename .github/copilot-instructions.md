# DashFleet Copilot Instructions
- Architecture: Flask server in [main.py](main.py) serves dashboards and REST APIs; lightweight agent in [fleet_agent.py](fleet_agent.py) collects psutil stats and POSTs to `/api/fleet/report`. State is held in-memory `FLEET_STATE`, persisted to SQLite `data/fleet.db` with JSON backup `logs/fleet_state.json` via [db_utils.py](db_utils.py).
- Security prerequisites: `SECRET_KEY` env must be set (dev override `ALLOW_DEV_INSECURE=1`). Dashboard routes use password gate `require_password` driven by `DASHBOARD_PASSWORD` or `config.json` (`dashboard_password`).
- Auth model: Multi-tenant API keys mapped to organizations. `_check_org_key` accepts `Authorization: Bearer <api_key>` or server-side cookie `dashfleet_sid` issued by `/api/login` and stored in `sessions` table. Legacy `FLEET_TOKEN` seeds default org via `_create_default_org_from_env`.
- Admin token: `ACTION_TOKEN` protects org/key admin endpoints (`/api/orgs`, `/api/keys/revoke`, `/api/tokens*`, `/api/agent/link`, `/api/action`). No token â†’ 403. First org created becomes `role=admin`.
- Rate limits: `flask_limiter` default 100/min; `/api/action` 10/min, `/api/fleet/report` 30/min (see [main.py](main.py)).
- Persistence schema: `_ensure_db_schema` creates `organizations`, `api_keys`, `fleet`, `sessions`, `download_tokens`; `_save_fleet_state` upserts fleet entries and writes JSON backup. Fleet TTL configurable via `FLEET_TTL_SECONDS` (default 600); expired entries purged on read and reload.
- Fleet reporting: `/api/fleet/report` validates payload with Marshmallow `ReportSchema`/`MetricsSchema`, stores entry keyed by `org_id:machine_id`, logs client IP/UA, and exposes per-org filtering on `/api/fleet`. Use the same org API key in agents.
- Agent usage: `python fleet_agent.py --server http://host:5000 --token <api_key> --machine-id <id> --interval <s>`; token priority CLI > env FLEET_TOKEN > config file. Health score logic mirrors server-side.
- Session/password bootstrapping: Optional admin bootstrap via `ADMIN_BOOTSTRAP_USERNAME`/`ADMIN_BOOTSTRAP_PASSWORD` (and `ADMIN_FORCE_BOOTSTRAP`). A one-time `/init-admin` exists but should stay disabled in production. Login/password required to view `/`, `/history`, `/fleet`, `/help`, `/admin/*`.
- Actions: `/api/action` runs whitelisted `APPROVED_ACTIONS` (flush DNS, restart spooler, cleanup temp/Teams/Outlook, collect logs). Many are Windows-only; keep list centralized in [main.py](main.py).
- Download links: `/api/agent/link` creates one-time download tokens stored in `download_tokens`; `/download/agent/<token>` consumes and serves the binary (default `dist/fleet_agent.exe`).
- Webhooks: if `WEBHOOK_URL` set, critical health in `/api/status` triggers POSTs throttled by `WEBHOOK_MIN_SECONDS`.
- CLI vs web: `python main.py --web` is default when no args; background exporters (CSV/JSONL) start when export paths provided. CLI mode supports `--server` + env `FLEET_API_KEY` to push remote reports.
- Tests: `tests/test_fleet_persistence.py` and `tests/test_fleet_expiration.py` expect a running server, env `FLEET_TOKEN` (or org API key) set, and will read/write `logs/fleet_state.json` / `data/fleet.db`. They assume base URL from `TEST_SERVER` (default http://localhost:5000).
- Deployment: See [deploy/README.md](deploy/README.md) for gunicorn + systemd + nginx; service example loads env from `.env` with `FLEET_TOKEN`/`ACTION_TOKEN`. Windows/Linux agent installers live under `deploy/` and `scripts/`.
- UI assets: Templates under [templates/](templates) (notably `fleet.html`) and JS/CSS under [static/](static); fleet page receives `fleet_ttl_seconds` from Flask for client-side expiration display.
- Logging/paths: API logs to `logs/api.log`; history CSV default `logs/metrics.csv`, exports default to user Desktop when unspecified.
- Keep responses/translations: client strings rely on [static/i18n.js](static/i18n.js) for FR/EN/ES/RU; avoid removing keys without updating templates.
