<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tableau de bord système</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/i18n.js"></script>
</head>
<body>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow" id="live-eyebrow">Statut en direct</p>
        <h1 id="title-main">Tableau de bord système</h1>
        <p class="lede" id="subtitle-main">CPU, mémoire, disque et uptime mis à jour toutes les quelques secondes.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <div class="badge" id="alert-badge">Tout va bien</div>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/" class="active" id="nav-live">Temps réel</a>
      <a href="/history" id="nav-history">Historique</a>
    </nav>

    <section class="grid">
      <article class="card" id="cpu-card">
        <div class="label" id="label-cpu">CPU</div>
        <div class="value" id="cpu-value">--%</div>
        <div class="meta" id="cpu-meta">En attente des données</div>
      </article>

      <article class="card" id="ram-card">
        <div class="label" id="label-ram">RAM</div>
        <div class="value" id="ram-value">--%</div>
        <div class="meta" id="ram-meta">En attente des données</div>
      </article>

      <article class="card" id="disk-card">
        <div class="label" id="label-disk">Disque</div>
        <div class="value" id="disk-value">--%</div>
        <div class="meta" id="disk-meta">En attente des données</div>
      </article>

      <article class="card" id="uptime-card">
        <div class="label" id="label-uptime">Uptime</div>
        <div class="value" id="uptime-value">--:--:--</div>
        <div class="meta" id="uptime-meta">depuis le démarrage</div>
      </article>
    </section>

    <section class="chart-card">
      <div class="table-header">
        <h2 id="chart-title">Tendance CPU / RAM</h2>
        <span class="muted" id="chart-subtitle">60 derniers points</span>
      </div>
      <canvas id="trend-chart" height="120"></canvas>
    </section>

    <section class="table-wrap">
      <div class="table-header">
        <h2 id="table-title">Dernière mesure</h2>
        <span id="timestamp">--</span>
      </div>
      <table>
        <thead>
          <tr>
            <th id="col-metric">Métrique</th>
            <th id="col-value">Valeur</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>CPU</td><td id="row-cpu">--</td></tr>
          <tr><td>RAM</td><td id="row-ram">--</td></tr>
          <tr><td>Disque</td><td id="row-disk">--</td></tr>
          <tr><td>Uptime</td><td id="row-uptime">--</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    const alertBadge = document.getElementById('alert-badge');
    const langSelect = document.getElementById('lang-select');
    let t = dashboardI18n.get();

    const maxPoints = 60;
    const labels = [];
    const cpuSeries = [];
    const ramSeries = [];

    const chartCtx = document.getElementById('trend-chart').getContext('2d');
    const trendChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'CPU %',
            data: cpuSeries,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56, 189, 248, 0.12)',
            borderWidth: 2,
            tension: 0.25,
          },
          {
            label: 'RAM %',
            data: ramSeries,
            borderColor: '#f43f5e',
            backgroundColor: 'rgba(244, 63, 94, 0.12)',
            borderWidth: 2,
            tension: 0.25,
          },
        ],
      },
      options: {
        plugins: {
          legend: { labels: { color: '#e5e7eb' } },
        },
        scales: {
          x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' }, suggestedMin: 0, suggestedMax: 100 },
        },
      },
    });

    function applyStaticTexts() {
      document.getElementById('live-eyebrow').textContent = t.liveEyebrow;
      document.getElementById('title-main').textContent = t.title;
      document.getElementById('subtitle-main').textContent = t.subtitle;
      document.getElementById('lang-label').textContent = t.langLabel;
      document.getElementById('nav-live').textContent = t.navLive;
      document.getElementById('nav-history').textContent = t.navHistory;

      document.getElementById('chart-title').textContent = t.chartTitle;
      document.getElementById('chart-subtitle').textContent = t.chartSubtitle;
      document.getElementById('table-title').textContent = t.lastMeasure;
      document.getElementById('col-metric').textContent = t.metric;
      document.getElementById('col-value').textContent = t.value;

      document.getElementById('label-cpu').textContent = t.cpuLabel;
      document.getElementById('label-ram').textContent = t.ramLabel;
      document.getElementById('label-disk').textContent = t.diskLabel;
      document.getElementById('label-uptime').textContent = t.uptimeLabel;

      document.getElementById('cpu-meta').textContent = t.metaWaiting;
      document.getElementById('ram-meta').textContent = t.metaWaiting;
      document.getElementById('disk-meta').textContent = t.metaWaiting;
      document.getElementById('uptime-meta').textContent = t.uptimeMeta;

      trendChart.data.datasets[0].label = t.seriesCpu || t.cpuLabel;
      trendChart.data.datasets[1].label = t.seriesRam || t.ramLabel;
      trendChart.update();

      const isAlert = alertBadge.classList.contains('alert');
      setAlert(isAlert);
    }

    function setAlert(active) {
      if (active) {
        alertBadge.textContent = t.badgeAlert;
        alertBadge.classList.add('alert');
      } else {
        alertBadge.textContent = t.badgeOk;
        alertBadge.classList.remove('alert');
      }
    }

    function updateCard(id, valueText, metaText, alert) {
      const card = document.getElementById(id);
      card.querySelector('.value').textContent = valueText;
      card.querySelector('.meta').textContent = metaText;
      card.classList.toggle('alert', alert);
    }

    function addPoint(timestamp, cpuPercent, ramPercent) {
      const label = timestamp.split('T')[1]?.slice(0, 8) || timestamp;
      labels.push(label);
      cpuSeries.push(cpuPercent);
      ramSeries.push(ramPercent);

      if (labels.length > maxPoints) {
        labels.shift();
        cpuSeries.shift();
        ramSeries.shift();
      }

      trendChart.update();
    }

    function refresh() {
      fetch('/api/stats')
        .then((resp) => resp.json())
        .then((data) => {
          const cpuText = `${data.cpu_percent.toFixed(1)}%`;
          const ramText = `${data.ram_percent.toFixed(1)}%`;
          const diskText = `${data.disk_percent.toFixed(1)}%`;

          updateCard('cpu-card', cpuText, t.cpuThreshold, data.alerts.cpu);
          updateCard('ram-card', ramText, t.ramMeta(data.ram_used_gib.toFixed(2), data.ram_total_gib.toFixed(2)), data.alerts.ram);
          updateCard('disk-card', diskText, t.diskMeta(data.disk_used_gib.toFixed(2), data.disk_total_gib.toFixed(2)), false);
          updateCard('uptime-card', data.uptime_hms, t.uptimeMeta, false);

          document.getElementById('timestamp').textContent = data.timestamp;
          document.getElementById('cpu-value').textContent = cpuText;
          document.getElementById('ram-value').textContent = ramText;
          document.getElementById('disk-value').textContent = diskText;
          document.getElementById('uptime-value').textContent = data.uptime_hms;

          document.getElementById('row-cpu').textContent = cpuText + (data.alerts.cpu ? t.alertTag : '');
          document.getElementById('row-ram').textContent = `${ramText} (${t.ramDetail(data.ram_used_gib.toFixed(2), data.ram_total_gib.toFixed(2))})` + (data.alerts.ram ? t.alertTag : '');
          document.getElementById('row-disk').textContent = `${diskText} (${t.diskDetail(data.disk_used_gib.toFixed(2), data.disk_total_gib.toFixed(2))})`;
          document.getElementById('row-uptime').textContent = data.uptime_hms;

          setAlert(data.alert_active);
          addPoint(data.timestamp, data.cpu_percent, data.ram_percent);
        })
        .catch((err) => {
          console.error(err);
          alertBadge.textContent = t.badgeAlert;
          alertBadge.classList.add('alert');
        });
    }

    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) {
        langSelect.value = lang;
      }
      applyStaticTexts();
    });

    refresh();
    setInterval(refresh, 2500);
  </script>
</body>
</html>
