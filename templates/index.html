<!doctype html>
<html lang="en">
<head>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tableau de bord système</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/i18n.js"></script>
  <script src="/static/fleet-auth.js"></script>
</head>
<body>
    <div id="toast" class="toast" role="status" aria-live="polite" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);background:var(--accent);color:#04263a;padding:14px 24px;border-radius:12px;z-index:9999;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,0.18);font-size:1.1em;min-width:220px;text-align:center;"></div>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow" id="live-eyebrow">Statut en direct</p>
        <h1 id="title-main">Tableau de bord système</h1>
        <p class="lede" id="subtitle-main">CPU, mémoire, disque et uptime mis à jour toutes les quelques secondes.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le thème clair/sombre" tabindex="1">Mode sombre</button>
        <div class="badge" id="alert-badge">Tout va bien</div>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/" class="active" id="nav-live">Temps réel</a>
      <a href="/history" id="nav-history">Historique</a>
      <a href="/fleet" id="nav-fleet">Fleet</a>
      <a href="/help" id="nav-help">Aide</a>
    </nav>

    <section class="grid">
      <article class="card status-ok" id="health-card" tabindex="2" aria-label="Carte santé">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div class="label" id="label-health">Santé</div>
          <span class="badge badge-score badge-ok" id="health-badge">--/100</span>
        </div>
        <div class="meta" id="health-meta">En attente des données</div>
      </article>

      <article class="card status-ok" id="cpu-card" tabindex="3" aria-label="Carte CPU">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="dot dot-ok" id="cpu-dot"></span>
          <div class="label" id="label-cpu">CPU</div>
        </div>
        <div class="value" id="cpu-value">--%</div>
        <div class="meta" id="cpu-meta">En attente des données</div>
      </article>

      <article class="card status-ok" id="ram-card" tabindex="4" aria-label="Carte RAM">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="dot dot-ok" id="ram-dot"></span>
          <div class="label" id="label-ram">RAM</div>
        </div>
        <div class="value" id="ram-value">--%</div>
        <div class="meta" id="ram-meta">En attente des données</div>
      </article>

      <article class="card status-ok" id="disk-card" tabindex="5" aria-label="Carte Disque">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="dot dot-ok" id="disk-dot"></span>
          <div class="label" id="label-disk">Disque</div>
        </div>
        <div class="value" id="disk-value">--%</div>
        <div class="meta" id="disk-meta">En attente des données</div>
      </article>

      <article class="card" id="uptime-card" tabindex="6" aria-label="Carte Uptime">
          <script>
            // Toast universel
            function showToast(msg, type='info', duration=3000) {
              const toast = document.getElementById('toast');
              toast.textContent = msg;
              toast.style.background = type==='error' ? '#f43f5e' : (type==='success' ? '#22c55e' : 'var(--accent)');
              toast.style.color = type==='error' ? '#fff' : '#04263a';
              toast.style.display = 'block';
              setTimeout(()=>{ toast.style.display = 'none'; }, duration);
            }
            // Exemple d'utilisation : showToast('Action réussie', 'success');
          </script>
        <div class="label" id="label-uptime">Uptime</div>
        <div class="value" id="uptime-value">--:--:--</div>
        <div class="meta" id="uptime-meta">depuis le démarrage</div>
      </article>
      <style>
        .dot { display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:5px;vertical-align:middle; }
        .dot-ok { background:#22c55e; }
        .dot-warn { background:#facc15; }
        .dot-critical { background:#f43f5e; }
        .dot-expired { background:#f59e42; }
        .badge-score { font-size:18px;padding:4px 12px;border-radius:16px;font-weight:700;background:rgba(56,189,248,0.10);border:1.5px solid var(--border);color:var(--text);min-width:60px;text-align:center; }
        .badge-ok { background:#22c55e22; border-color:#22c55e; color:#22c55e; }
        .badge-warn { background:#facc1522; border-color:#facc15; color:#facc15; }
        .badge-critical { background:#f43f5e22; border-color:#f43f5e; color:#f43f5e; }
        .badge-expired { background:#f59e4222; border-color:#f59e42; color:#f59e42; }
      </style>
      <script>
        // Met à jour le badge santé et les pastilles selon le score/status
        function updateHealthUI(score, status) {
          const badge = document.getElementById('health-badge');
          badge.textContent = (score ?? '--') + '/100';
          badge.className = 'badge badge-score badge-' + (status || 'ok');
          document.getElementById('health-card').className = 'card status-' + (status || 'ok');
        }
        function updateCardDot(id, status) {
          const dot = document.getElementById(id+'-dot');
          if(dot) dot.className = 'dot dot-' + (status || 'ok');
          const card = document.getElementById(id+'-card');
          if(card) card.className = 'card status-' + (status || 'ok');
        }
        // Hook sur la fonction de mise à jour existante (à adapter selon ton JS)
        // Exemple d'appel : updateHealthUI(85, 'ok'); updateCardDot('cpu', 'warn');
      </script>
    </section>

    <section class="chart-card">
      <div class="table-header">
        <h2 id="chart-title">Tendance CPU / RAM</h2>
        <span class="muted" id="chart-subtitle">60 derniers points</span>
      </div>
      <canvas id="trend-chart" height="120"></canvas>
    </section>

    <section class="actions-wrap">
      <div class="table-header">
        <h2 id="actions-title">Actions approuvées</h2>
        <span class="muted" id="actions-subtitle">Exécutées localement</span>
      </div>
      <div class="actions-grid">
        <button class="action-btn" data-action="flush_dns" id="action-flush">Flush DNS</button>
        <button class="action-btn" data-action="restart_spooler" id="action-spooler">Restart Spooler</button>
        <button class="action-btn" data-action="cleanup_temp" id="action-cleanup">Nettoyer Temp</button>
        <button class="action-btn" data-action="cleanup_teams" id="action-teams">Cache Teams</button>
        <button class="action-btn" data-action="cleanup_outlook" id="action-outlook">Caches Outlook</button>
        <button class="action-btn" data-action="collect_logs" id="action-logs">Collecter logs</button>
      </div>
      <div class="action-log" id="action-log">Prêt</div>
    </section>

    <section class="table-wrap">
      <div class="table-header">
        <h2 id="table-title">Dernière mesure</h2>
        <span id="timestamp">--</span>
      </div>
      <table>
        <thead>
          <tr>
            <th id="col-metric">Métrique</th>
            <th id="col-value">Valeur</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>CPU</td><td id="row-cpu">--</td></tr>
          <tr><td>RAM</td><td id="row-ram">--</td></tr>
          <tr><td>Disque</td><td id="row-disk">--</td></tr>
          <tr><td>Uptime</td><td id="row-uptime">--</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    const alertBadge = document.getElementById('alert-badge');
    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    let t = dashboardI18n.get();
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';

    const maxPoints = 60;
    const labels = [];
    const cpuSeries = [];
    const ramSeries = [];

    const chartCtx = document.getElementById('trend-chart').getContext('2d');
    const trendChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'CPU %',
            data: cpuSeries,
            borderColor: '#38bdf8',
            backgroundColor: 'rgba(56, 189, 248, 0.12)',
            borderWidth: 2,
            tension: 0.25,
          },
          {
            label: 'RAM %',
            data: ramSeries,
            borderColor: '#f43f5e',
            backgroundColor: 'rgba(244, 63, 94, 0.12)',
            borderWidth: 2,
            tension: 0.25,
          },
        ],
      },
      options: {
        plugins: {
          legend: { labels: { color: '#e5e7eb' } },
        },
        scales: {
          x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' }, suggestedMin: 0, suggestedMax: 100 },
        },
      },
    });

    function updateChartTheme() {
      const styles = getComputedStyle(document.body);
      const muted = styles.getPropertyValue('--muted') || '#9ca3af';
      const grid = styles.getPropertyValue('--border') || 'rgba(255,255,255,0.05)';
      trendChart.options.plugins.legend.labels.color = muted.trim();
      trendChart.options.scales.x.ticks.color = muted.trim();
      trendChart.options.scales.y.ticks.color = muted.trim();
      trendChart.options.scales.x.grid.color = grid.trim();
      trendChart.options.scales.y.grid.color = grid.trim();
      trendChart.update();
    }

    function applyStaticTexts() {
      document.getElementById('live-eyebrow').textContent = t.liveEyebrow;
      document.getElementById('title-main').textContent = t.title;
      document.getElementById('subtitle-main').textContent = t.subtitle;
      document.getElementById('lang-label').textContent = t.langLabel;
      document.getElementById('nav-live').textContent = t.navLive;
      document.getElementById('nav-history').textContent = t.navHistory;
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';

      document.getElementById('chart-title').textContent = t.chartTitle;
      document.getElementById('chart-subtitle').textContent = t.chartSubtitle;
      document.getElementById('table-title').textContent = t.lastMeasure;
      document.getElementById('col-metric').textContent = t.metric;
      document.getElementById('col-value').textContent = t.value;

      document.getElementById('label-health').textContent = t.healthLabel || 'Santé';
      document.getElementById('label-cpu').textContent = t.cpuLabel;
      document.getElementById('label-ram').textContent = t.ramLabel;
      document.getElementById('label-disk').textContent = t.diskLabel;
      document.getElementById('label-uptime').textContent = t.uptimeLabel;

      document.getElementById('cpu-meta').textContent = t.metaWaiting;
      document.getElementById('ram-meta').textContent = t.metaWaiting;
      document.getElementById('disk-meta').textContent = t.metaWaiting;
      document.getElementById('uptime-meta').textContent = t.uptimeMeta;

      document.getElementById('actions-title').textContent = t.actionsTitle || 'Actions approuvées';
      document.getElementById('actions-subtitle').textContent = t.actionsSubtitle || 'Exécutées localement';
      document.getElementById('action-flush').textContent = t.actionFlush || 'Flush DNS';
      document.getElementById('action-spooler').textContent = t.actionSpooler || 'Restart Spooler';
      document.getElementById('action-cleanup').textContent = t.actionCleanup || 'Nettoyer Temp';
      document.getElementById('action-teams').textContent = t.actionTeams || 'Cache Teams';
      document.getElementById('action-outlook').textContent = t.actionOutlook || 'Caches Outlook';
      document.getElementById('action-logs').textContent = t.actionLogs || 'Collecter logs';
      document.getElementById('action-log').textContent = t.actionReady || 'Prêt';

      updateThemeButton();

      trendChart.data.datasets[0].label = t.seriesCpu || t.cpuLabel;
      trendChart.data.datasets[1].label = t.seriesRam || t.ramLabel;
      updateChartTheme();

      const isAlert = alertBadge.classList.contains('alert');
      setAlert(isAlert);
    }

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
      updateChartTheme();
    }

    function setAlert(active) {
      if (active) {
        alertBadge.textContent = t.badgeAlert;
        alertBadge.classList.add('alert');
      } else {
        alertBadge.textContent = t.badgeOk;
        alertBadge.classList.remove('alert');
      }
    }

    function updateCard(id, valueText, metaText, alert) {
      const card = document.getElementById(id);
      card.querySelector('.value').textContent = valueText;
      card.querySelector('.meta').textContent = metaText;
      card.classList.toggle('alert', alert);
    }

    function addPoint(timestamp, cpuPercent, ramPercent) {
      const label = timestamp.split('T')[1]?.slice(0, 8) || timestamp;
      labels.push(label);
      cpuSeries.push(cpuPercent);
      ramSeries.push(ramPercent);

      if (labels.length > maxPoints) {
        labels.shift();
        cpuSeries.shift();
        ramSeries.shift();
      }

      trendChart.update();
    }

    function logAction(message, isError = false) {
      const logEl = document.getElementById('action-log');
      logEl.textContent = message;
      logEl.style.color = isError ? '#f43f5e' : '#9ca3af';
    }

    function runAction(actionName) {
      logAction(t.actionRunning || 'Exécution...', false);
      fetch('/api/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: actionName }),
      })
        .then((resp) => resp.json().then((data) => ({ status: resp.status, data })))
        .then(({ status, data }) => {
          if (status >= 400 || data.error || data.ok === false) {
            logAction(`${t.actionFailure || 'Échec'}: ${data.error || data.message || data.stderr || ''}`, true);
            return;
          }
          logAction(`${t.actionSuccess || 'Succès'}: ${data.message || data.stdout || actionName}`, false);
        })
        .catch((err) => {
          console.error(err);
          logAction(`${t.actionFailure || 'Échec'}: ${err}`, true);
        });
    }

    function refresh() {
      authFetch('/api/status')
        .then((resp) => resp.json())
        .then((data) => {
          const cpuText = `${data.cpu_percent.toFixed(1)}%`;
          const ramText = `${data.ram_percent.toFixed(1)}%`;
          const diskText = `${data.disk_percent.toFixed(1)}%`;
          const health = data.health || { score: 0, status: 'ok', components: {} };

          document.getElementById('health-value').textContent = `${health.score}/100`;
          const metaByStatus = {
            ok: t.healthMetaOk || 'Statut OK',
            warn: t.healthMetaWarn || 'Statut avertissement',
            critical: t.healthMetaCritical || 'Statut critique',
          };
          document.getElementById('health-meta').textContent = metaByStatus[health.status] || metaByStatus.ok;

          const healthCard = document.getElementById('health-card');
          healthCard.classList.remove('status-ok', 'status-warn', 'status-critical');
          healthCard.classList.add(`status-${health.status}`);

          updateCard('cpu-card', cpuText, t.cpuThreshold, data.alerts.cpu);
          updateCard('ram-card', ramText, t.ramMeta(data.ram_used_gib.toFixed(2), data.ram_total_gib.toFixed(2)), data.alerts.ram);
          updateCard('disk-card', diskText, t.diskMeta(data.disk_used_gib.toFixed(2), data.disk_total_gib.toFixed(2)), false);
          updateCard('uptime-card', data.uptime_hms, t.uptimeMeta, false);

          document.getElementById('timestamp').textContent = data.timestamp;
          document.getElementById('cpu-value').textContent = cpuText;
          document.getElementById('ram-value').textContent = ramText;
          document.getElementById('disk-value').textContent = diskText;
          document.getElementById('uptime-value').textContent = data.uptime_hms;

          document.getElementById('row-cpu').textContent = cpuText + (data.alerts.cpu ? t.alertTag : '');
          document.getElementById('row-ram').textContent = `${ramText} (${t.ramDetail(data.ram_used_gib.toFixed(2), data.ram_total_gib.toFixed(2))})` + (data.alerts.ram ? t.alertTag : '');
          document.getElementById('row-disk').textContent = `${diskText} (${t.diskDetail(data.disk_used_gib.toFixed(2), data.disk_total_gib.toFixed(2))})`;
          document.getElementById('row-uptime').textContent = data.uptime_hms;

          setAlert(data.alert_active);
          addPoint(data.timestamp, data.cpu_percent, data.ram_percent);
        })
        .catch((err) => {
          console.error(err);
          alertBadge.textContent = t.badgeAlert;
          alertBadge.classList.add('alert');
        });
    }

    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) {
        langSelect.value = lang;
      }
      applyStaticTexts();
    });

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    setTheme(theme);

    document.querySelectorAll('.action-btn').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const actionName = e.currentTarget.getAttribute('data-action');
        runAction(actionName);
      });
    });

    refresh();
    setInterval(refresh, 2500);
  </script>
</body>
</html>
