<!doctype html>
<html lang="fr">
<head>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Organizations - DashFleet</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.12), transparent 25%), radial-gradient(circle at 80% 0%, rgba(244, 63, 94, 0.12), transparent 30%), var(--bg); color: var(--text); font-family: 'Space Grotesk', Arial, sans-serif; }
    .admin-orgs-box { max-width: 600px; margin: 40px auto; padding: 2.2em 2em 2em; background: var(--panel); border: 1.5px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); }
    .admin-orgs-box h1 { margin-top: 0; font-size: 1.5em; color: var(--accent); }
    .admin-orgs-box h2 { margin-bottom: 8px; color: var(--text); }
    .admin-orgs-box label { font-size: 1em; color: var(--muted); }
    .admin-orgs-box input[type="text"], .admin-orgs-box input[type="password"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 6px; font-size: 1em; background: rgba(255,255,255,0.04); color: var(--text); }
    .admin-orgs-box button { margin-top: 10px; padding: 10px 18px; border-radius: 10px; border: none; background: var(--accent); color: #04263a; font-weight: 700; font-size: 1em; cursor: pointer; transition: background 0.15s; }
    .admin-orgs-box button:hover { background: #0ea5e9; }
    .org { border:1.5px solid var(--border); background: var(--panel); border-radius: 10px; padding: 12px; margin: 12px 0; box-shadow: var(--shadow); }
    .key { font-family: monospace; background: #22c55e22; color: #22c55e; padding: 0.4em 0.8em; border-radius: 6px; font-size: 1em; margin: 2px 0; border: 1.5px solid #22c55e; display: inline-block; }
    @media (max-width: 700px) { .admin-orgs-box { padding: 1.2em 0.5em; } }
  </style>
</head>
<body>
  <div class="admin-orgs-box">
    <h1>Administration - Organisations et clés</h1>
    <div style="margin-bottom:18px">
      <label>Token admin (ACTION_TOKEN) :
        <input id="adminToken" type="password" placeholder="ACTION_TOKEN" autocomplete="off">
      </label>
      <button id="btnList">Lister</button>
    </div>
    <h2>Créer nouvelle organisation</h2>
    <div style="margin-bottom:18px">
      <input id="orgName" placeholder="Nom de l'organisation">
      <button id="btnCreate">Créer</button>
    </div>
    <h2>Organisations</h2>
    <div id="orgs"></div>
  </div>
  <script>
    const elOrgs = document.getElementById('orgs')
    const getToken = ()=>document.getElementById('adminToken').value.trim()

    async function listOrgs(){
      const token = getToken()
      if(!token){ alert('Entrez ACTION_TOKEN'); return }
      const res = await fetch('/api/orgs',{headers:{'Authorization':'Bearer '+token}})
      const j = await res.json()
      if(res.status!==200){ alert(JSON.stringify(j)); return }
      renderOrgs(j.orgs||[])
    }

    function renderOrgs(orgs){
      elOrgs.innerHTML=''
      if(!orgs.length){ elOrgs.textContent='Aucune organisation.'; return }
      orgs.forEach(o=>{
        const d = document.createElement('div'); d.className='org'
        const h = document.createElement('div'); h.innerHTML=`<strong>${o.name}</strong> <code>${o.org_id}</code>`
        d.appendChild(h)
        if(o.keys && o.keys.length){
          o.keys.forEach(k=>{
            const kdiv = document.createElement('div')
            kdiv.innerHTML = `<span class='key'>${k.key_masked}</span> - créé: ${new Date(k.created_at*1000).toLocaleString()} - revoked: ${k.revoked}`
            const btn = document.createElement('button')
            btn.textContent = k.revoked ? 'Restaurer' : 'Révoquer'
            btn.onclick = ()=>toggleKey(k, !k.revoked)
            kdiv.appendChild(btn)
            d.appendChild(kdiv)
          })
        } else {
          const p = document.createElement('div'); p.textContent='Aucune clé.'; d.appendChild(p)
        }
        elOrgs.appendChild(d)
      })
    }

    async function toggleKey(k, revoke){
      const token = getToken();
      if(!token){ alert('Entrez ACTION_TOKEN'); return }
      const payload = { key: k.key_masked ? k.key_masked.replace(/\.\.\./, '') : '' , revoke: revoke }
      // The masked key isn't the real key; instead we ask admin to paste the full key in a prompt:
      const full = prompt('Collez la clé complète à (ré)voquer (sera masquée dans l\'UI)')
      if(!full) return
      const body = { key: full, revoke: revoke }
      const res = await fetch('/api/keys/revoke',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(body)})
      const j = await res.json()
      if(res.status===200){ alert('OK'); listOrgs() } else { alert(JSON.stringify(j)) }
    }

    document.getElementById('btnList').addEventListener('click', listOrgs)
    document.getElementById('btnCreate').addEventListener('click', async ()=>{
      const token = getToken(); if(!token){ alert('Entrez ACTION_TOKEN'); return }
      const name = document.getElementById('orgName').value.trim(); if(!name){ alert('Nom requis'); return }
      const res = await fetch('/api/orgs',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({name:name})})
      const j = await res.json()
      if(res.status===200){ alert('Organisation créée. Clé API:\n'+j.api_key); listOrgs() } else { alert(JSON.stringify(j)) }
    })
  </script>
</body>
</html>
