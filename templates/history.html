<!doctype html>
<html lang="fr">
<head>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Historique - Tableau de bord système</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/i18n.js"></script>
  <script src="/static/fleet-auth.js"></script>
  <style>
    .badge-score { font-size:18px;padding:4px 12px;border-radius:16px;font-weight:700;background:rgba(56,189,248,0.10);border:1.5px solid var(--border);color:var(--text);min-width:60px;text-align:center; }
    .badge-ok { background:#22c55e22; border-color:#22c55e; color:#22c55e; }
    .badge-warn { background:#facc1522; border-color:#facc15; color:#facc15; }
    .badge-critical { background:#f43f5e22; border-color:#f43f5e; color:#f43f5e; }
    .badge-expired { background:#f59e4222; border-color:#f59e42; color:#f59e42; }
  </style>
</head>
<body>
    <div id="toast" class="toast" role="status" aria-live="polite" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);background:var(--accent);color:#04263a;padding:14px 24px;border-radius:12px;z-index:9999;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,0.18);font-size:1.1em;min-width:220px;text-align:center;"></div>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow" id="history-eyebrow">Historique</p>
        <h1 id="history-title">Courbes CPU / RAM / Disque</h1>
        <p class="lede" id="history-subtitle">Affiche les points enregistrés dans le CSV (logs/metrics.csv). Lancer l’export pour alimenter les courbes.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le thème clair/sombre" tabindex="1">Mode sombre</button>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/" id="nav-live">Temps réel</a>
      <a href="/history" class="active" id="nav-history">Historique</a>
      <a href="/fleet" id="nav-fleet">Fleet</a>
      <a href="/help" id="nav-help">Aide</a>
    </nav>

    <section class="chart-card">
      <div class="table-header">
        <h2 id="history-chart-title">Séries temporelles</h2>
        <span class="muted" id="meta-count">0 points</span>
      </div>
      <canvas id="history-chart" height="150"></canvas>
    </section>

    <section class="table-wrap">
      <div class="table-header">
        <h2 id="health-title">Santé actuelle</h2>
        <span class="muted" id="health-timestamp">--</span>
      </div>
      <div class="grid">
        <article class="card status-ok" id="health-card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div class="label" id="label-health">Santé</div>
            <span class="badge badge-score badge-ok" id="health-badge">--/100</span>
          </div>
          <div class="meta" id="health-meta">En attente des données</div>
        </article>
      </div>
    </section>
    <script>
      // Met à jour le badge santé selon le score/status (à appeler dans ton JS)
      function updateHistoryHealthUI(score, status) {
        const badge = document.getElementById('health-badge');
        badge.textContent = (score ?? '--') + '/100';
        badge.className = 'badge badge-score badge-' + (status || 'ok');
        document.getElementById('health-card').className = 'card status-' + (status || 'ok');
      }
    </script>

    <section class="table-wrap" id="table-wrap">
      <div class="table-header">
        <h2 id="history-table-title">Dernières entrées</h2>
        <span class="muted" id="history-table-subtitle">Heure locale</span>
      </div>
      <table aria-label="Tableau historique" tabindex="2">
        <thead>
          <tr>
            <th id="th-ts">Timestamp</th>
            <th id="th-cpu">CPU %</th>
            <th id="th-ram">RAM %</th>
            <th id="th-disk">Disque %</th>
            <th id="th-uptime">Uptime</th>
          </tr>
        </thead>
        <tbody id="history-body"></tbody>
      </table>
      <script>
        // Toast universel
        function showToast(msg, type='info', duration=3000) {
          const toast = document.getElementById('toast');
          toast.textContent = msg;
          toast.style.background = type==='error' ? '#f43f5e' : (type==='success' ? '#22c55e' : 'var(--accent)');
          toast.style.color = type==='error' ? '#fff' : '#04263a';
          toast.style.display = 'block';
          setTimeout(()=>{ toast.style.display = 'none'; }, duration);
        }
        // Exemple d'utilisation : showToast('Action réussie', 'success');
      </script>
    </section>

    <div class="empty" id="empty-state" hidden>
      <p id="empty-title">Aucun historique trouvé.</p>
      <p class="muted" id="empty-hint">Lance d’abord une collecte :<br> <code id="empty-code">python main.py --export-csv logs/metrics.csv</code></p>
    </div>
  </main>

  <script>
    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    let t = dashboardI18n.get();
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';
    const healthCard = document.getElementById('health-card');

    const chartCtx = document.getElementById('history-chart').getContext('2d');
    const labels = [];
    const cpuSeries = [];
    const ramSeries = [];
    const diskSeries = [];

    const historyChart = new Chart(chartCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'CPU %', data: cpuSeries, borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.12)', borderWidth: 2, tension: 0.25 },
          { label: 'RAM %', data: ramSeries, borderColor: '#f43f5e', backgroundColor: 'rgba(244,63,94,0.12)', borderWidth: 2, tension: 0.25 },
          { label: 'Disque %', data: diskSeries, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.12)', borderWidth: 2, tension: 0.25 },
        ],
      },
      options: {
        plugins: { legend: { labels: { color: '#e5e7eb' } } },
        scales: {
          x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' }, suggestedMin: 0, suggestedMax: 100 },
        },
      },
    });

    function updateChartTheme() {
      const styles = getComputedStyle(document.body);
      const muted = styles.getPropertyValue('--muted') || '#9ca3af';
      const grid = styles.getPropertyValue('--border') || 'rgba(255,255,255,0.05)';
      historyChart.options.plugins.legend.labels.color = muted.trim();
      historyChart.options.scales.x.ticks.color = muted.trim();
      historyChart.options.scales.y.ticks.color = muted.trim();
      historyChart.options.scales.x.grid.color = grid.trim();
      historyChart.options.scales.y.grid.color = grid.trim();
      historyChart.update();
    }

    function applyStaticTexts() {
      document.getElementById('lang-label').textContent = t.langLabel;
      document.getElementById('nav-live').textContent = t.navLive;
      document.getElementById('nav-history').textContent = t.navHistory;
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';

      document.getElementById('history-eyebrow').textContent = t.historyEyebrow;
      document.getElementById('history-title').textContent = t.historyTitle;
      document.getElementById('history-subtitle').textContent = t.historySubtitle;
      document.getElementById('history-chart-title').textContent = t.historyChartTitle;
      document.getElementById('history-table-title').textContent = t.historyTableTitle;
      document.getElementById('history-table-subtitle').textContent = t.historyTableSubtitle;

      document.getElementById('health-title').textContent = t.healthLabel || 'Santé';
      document.getElementById('label-health').textContent = t.healthLabel || 'Santé';

      document.getElementById('th-ts').textContent = t.timestampLabel;
      document.getElementById('th-cpu').textContent = t.seriesCpu;
      document.getElementById('th-ram').textContent = t.seriesRam;
      document.getElementById('th-disk').textContent = t.seriesDisk;
      document.getElementById('th-uptime').textContent = t.uptimeLabel;

      document.getElementById('empty-title').textContent = t.emptyTitle;
      document.getElementById('empty-hint').innerHTML = `${t.emptyHint}<br> <code id="empty-code">${t.emptyCode}</code>`;

      historyChart.data.datasets[0].label = t.seriesCpu;
      historyChart.data.datasets[1].label = t.seriesRam;
      historyChart.data.datasets[2].label = t.seriesDisk;
      updateChartTheme();

      updateThemeButton();
    }

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
      updateChartTheme();
    }

    function renderTable(rows) {
      const body = document.getElementById('history-body');
      body.innerHTML = '';
      rows.slice(-20).reverse().forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.timestamp}</td>
          <td>${row.cpu_percent.toFixed(1)}%</td>
          <td>${row.ram_percent.toFixed(1)}%</td>
          <td>${row.disk_percent.toFixed(1)}%</td>
          <td>${row.uptime_hms || ''}</td>
        `;
        body.appendChild(tr);
      });
    }

    function updateChart(rows) {
      labels.length = 0;
      cpuSeries.length = 0;
      ramSeries.length = 0;
      diskSeries.length = 0;

      rows.forEach((row) => {
        const timeLabel = row.timestamp.split('T')[1]?.slice(0, 8) || row.timestamp;
        labels.push(timeLabel);
        cpuSeries.push(row.cpu_percent);
        ramSeries.push(row.ram_percent);
        diskSeries.push(row.disk_percent);
      });

      historyChart.update();
    }

    function toggleEmpty(show) {
      document.getElementById('empty-state').hidden = !show;
      document.getElementById('table-wrap').style.display = show ? 'none' : 'block';
    }

    function updateHealth() {
      authFetch('/api/status')
        .then((resp) => resp.json())
        .then((data) => {
          const health = data.health || { score: 0, status: 'ok' };
          document.getElementById('health-value').textContent = `${health.score}/100`;
          const metaByStatus = {
            ok: t.healthMetaOk || 'Statut OK',
            warn: t.healthMetaWarn || 'Statut avertissement',
            critical: t.healthMetaCritical || 'Statut critique',
          };
          document.getElementById('health-meta').textContent = metaByStatus[health.status] || metaByStatus.ok;
          document.getElementById('health-timestamp').textContent = data.timestamp || '--';

          healthCard.classList.remove('status-ok', 'status-warn', 'status-critical');
          healthCard.classList.add(`status-${health.status}`);
        })
        .catch((err) => console.error(err));
    }

    function loadHistory() {
      authFetch('/api/history?limit=300')
        .then((resp) => resp.json())
        .then((payload) => {
          const rows = payload.data || [];
          document.getElementById('meta-count').textContent = t.pointsLabel(rows.length);

          if (!rows.length) {
            toggleEmpty(true);
            return;
          }

          toggleEmpty(false);
          updateChart(rows);
          renderTable(rows);
          updateHealth();
        })
        .catch((err) => {
          console.error(err);
          toggleEmpty(true);
        });
    }
    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) {
        langSelect.value = lang;
      }
      applyStaticTexts();
      loadHistory();
    });

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    setTheme(theme);
    updateHealth();
  </script>
</body>
</html>
