<!doctype html>
<html lang="fr">
<head>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fleet - Machines</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow">Fleet</p>
        <h1>Sant√© des postes</h1>
        <p class="lede">Vue centrale des machines report√©es par les agents.</p>
      </div>
      <div class="header-actions">
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le th√®me clair/sombre">Mode sombre</button>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/">Temps r√©el</a>
      <a href="/history">Historique</a>
      <a href="/fleet" class="active">Fleet</a>
      <a href="/help">Aide</a>
    </nav>

    <section class="table-wrap">
      <div class="table-header">
        <h2>Machines</h2>
        <span class="muted" id="machine-count">0 machines</span>
      </div>
      <div class="table-fleet" id="fleet-cards"></div>
    </section>

    <div class="empty" id="empty-state" hidden>
      <p>Aucune machine report√©e.</p>
    </div>
  </main>

  <script>
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';
    const themeToggle = document.getElementById('theme-toggle');

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      themeToggle.textContent = theme === 'dark' ? 'Mode clair' : 'Mode sombre';
    }

    setTheme(theme);
    themeToggle.addEventListener('click', () => setTheme(theme === 'dark' ? 'light' : 'dark'));

    function renderFleet(data) {
      const fleetCards = document.getElementById('fleet-cards');
      const emptyState = document.getElementById('empty-state');
      const machineCount = document.getElementById('machine-count');
      
      if (!data || data.length === 0) {
        fleetCards.innerHTML = '';
        emptyState.hidden = false;
        machineCount.textContent = '0 machines';
        return;
      }

      emptyState.hidden = true;
      machineCount.textContent = `${data.length} machine${data.length > 1 ? 's' : ''}`;
      
      fleetCards.innerHTML = data.map((entry, i) => {
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const now = Date.now() / 1000;
        const expired = (now - entry.ts > 600);
        const status = expired ? 'expired' : health.status;
        const lastSeen = new Date(entry.ts * 1000).toLocaleString();

        return `
          <article class="card status-${status}">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
              <div class="label">${entry.id || 'Machine'}</div>
              <span class="badge badge-score badge-${status}">${health.score || 0}/100</span>
            </div>
            <div class="meta"><span class="dot dot-${status}"></span> ${status.toUpperCase()} ¬∑ ${report.uptime_hms || '--'}</div>
            <div class="meta">üñ•Ô∏è CPU <b>${(report.cpu_percent || 0).toFixed(1)}</b>% ¬∑ üíæ RAM <b>${(report.ram_percent || 0).toFixed(1)}</b>% ¬∑ üì¶ Disk <b>${(report.disk_percent || 0).toFixed(1)}</b>%</div>
            <div class="meta muted">Dernier: ${lastSeen}${expired ? ' ‚ö†Ô∏è' : ''}</div>
          </article>
        `;
      }).join('');
    }

    function loadFleet() {
      fetch('/api/fleet/public')
        .then(r => r.json())
        .then(data => renderFleet(data.data || []))
        .catch(err => {
          console.error('Erreur:', err);
          document.getElementById('fleet-cards').innerHTML = '<div class="empty" style="margin:0;padding:16px;">Erreur de chargement</div>';
        });
    }

    // Charger au d√©marrage
    loadFleet();
    
    // Rafra√Æchir toutes les 5 secondes
    setInterval(loadFleet, 5000);
  </script>
</body>
</html>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow" id="fleet-eyebrow">Fleet</p>
        <h1 id="fleet-title">Sant√© des postes</h1>
        <p class="lede" id="fleet-subtitle">Vue centrale des machines report√©es par les agents.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le th√®me clair/sombre" tabindex="1">Mode sombre</button>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/" id="nav-live">Temps r√©el</a>
      <a href="/history" id="nav-history">Historique</a>
      <a href="/fleet" class="active" id="nav-fleet">Fleet</a>
      <a href="/help" id="nav-help">Aide</a>
    </nav>

    <section class="table-wrap">
      <div class="table-header">
        <h2 id="fleet-table-title">Machines</h2>
        <span class="muted" id="fleet-meta">--</span>
      </div>
      <div class="legend-status" style="margin-bottom:10px;font-size:13px;color:var(--muted);display:flex;gap:18px;flex-wrap:wrap;align-items:center;">
        <span><span class="dot dot-ok"></span> OK</span>
        <span><span class="dot dot-warn"></span> Warn</span>
        <span><span class="dot dot-critical"></span> Critical</span>
        <span><span class="dot dot-expired"></span> Expired</span>
        <span class="muted">¬∑ TTL {{ fleet_ttl_seconds }}s</span>
      </div>
      <div id="fleet-error" class="inline-error" role="status" aria-live="polite"></div>
      <div class="fleet-controls">
        <label>Statut:
          <select id="filter-status" class="control-select">
            <option value="all">Tous</option>
            <option value="ok">OK</option>
            <option value="warn">Warn</option>
            <option value="critical">Critical</option>
            <option value="expired">Expired</option>
          </select>
        </label>
        <label>Trier:
          <select id="sort-by" class="control-select">
            <option value="score_desc">Score (desc)</option>
            <option value="score_asc">Score (asc)</option>
            <option value="last_desc">Dernier (r√©cent)</option>
            <option value="last_asc">Dernier (ancien)</option>
          </select>
        </label>
      </div>
      <div class="table-fleet" id="fleet-cards" aria-label="Liste des machines" tabindex="2"></div>
    </section>

    <div class="empty" id="empty-state" hidden>
      <p id="empty-title">Aucune machine report√©e.</p>
      <p class="muted" id="empty-hint">D√©ployer un agent qui POST sur /api/fleet/report avec FLEET_TOKEN.</p>
    </div>
  </main>

  <script src="/static/fleet-auth.js"></script>
  <script>
    function showToast(msg, type='info', duration=3200) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.style.background = type==='error' ? '#f43f5e' : (type==='success' ? '#22c55e' : 'var(--accent)');
      toast.style.color = type==='error' ? '#fff' : '#04263a';
      toast.style.display = 'block';
      setTimeout(()=>{ toast.style.display = 'none'; }, duration);
    }

    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    const fleetCards = document.getElementById('fleet-cards');
    const filterStatus = document.getElementById('filter-status');
    const sortBy = document.getElementById('sort-by');
    const fleetTTL = parseInt('{{ fleet_ttl_seconds }}', 10) || 600;
    const refreshBaseMs = 5000;
    let refreshTimer = null;
    let errorStreak = 0;
    let loading = false;
    let fleetRawData = [];
    let t = dashboardI18n.get();
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
    }

    function applyStaticTexts() {
      document.getElementById('lang-label').textContent = t.langLabel;
      document.getElementById('nav-live').textContent = t.navLive;
      document.getElementById('nav-history').textContent = t.navHistory;
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';

      document.getElementById('fleet-eyebrow').textContent = t.fleetEyebrow || 'Fleet';
      document.getElementById('fleet-title').textContent = t.fleetTitle || 'Sant√© des postes';
      document.getElementById('fleet-subtitle').textContent = t.fleetSubtitle || 'Vue centrale des machines report√©es par les agents.';
      document.getElementById('fleet-table-title').textContent = t.fleetTableTitle || 'Machines';
      document.getElementById('empty-title').textContent = t.fleetEmptyTitle || 'Aucune machine report√©e.';
      document.getElementById('empty-hint').textContent = t.fleetEmptyHint || 'D√©ployer un agent qui POST sur /api/fleet/report avec FLEET_TOKEN.';
      updateThemeButton();
    }


    function statusClass(status, lastSeenTs) {
      const now = Date.now() / 1000;
      if (status === 'critical') return 'status-critical';
      if (now - lastSeenTs > 600) return 'status-expired';
      if (status === 'warn') return 'status-warn';
      return 'status-ok';
    }

    function renderSkeleton(count = 6) {
      fleetCards.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const card = document.createElement('article');
        card.className = 'skeleton fade-in';
        card.style.animationDelay = (i * 0.06) + 's';
        card.innerHTML = `
          <div class="skeleton-line wide"></div>
          <div class="skeleton-line mid"></div>
          <div class="skeleton-line short"></div>
        `;
        fleetCards.appendChild(card);
      }
    }

    function renderFleet(data) {
      fleetCards.innerHTML = '';
      if (!data.length) {
        document.getElementById('empty-state').hidden = false;
        return;
      }
      document.getElementById('empty-state').hidden = true;

      data.forEach((entry, i) => {
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const lastSeen = new Date(entry.ts * 1000).toLocaleString();
        const now = Date.now() / 1000;
        const expired = (now - entry.ts > fleetTTL);
        const status = expired ? 'expired' : health.status;
        const card = document.createElement('article');
        card.className = `card ${statusClass(status, entry.ts)} fade-in`;
        card.style.animationDelay = (i * 0.07) + 's';
        card.setAttribute('aria-label', `Machine ${entry.id || 'machine'}`);
        card.setAttribute('tabindex', 3 + i);
        card.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div class="label">${entry.id || 'machine'}</div>
            <span class="badge badge-score badge-${status} fade-in" style="animation-delay:${i*0.07+0.1}s">${health.score || 0}/100</span>
          </div>
          <div class="meta" style="margin-bottom:4px"><span class="dot dot-${status}"></span> ${status.toUpperCase()} ¬∑ ${report.uptime_hms || ''}</div>
          <div class="meta">CPU <b>${report.cpu_percent?.toFixed?.(1) || '--'}</b>% ¬∑ RAM <b>${report.ram_percent?.toFixed?.(1) || '--'}</b>% ¬∑ Disk <b>${report.disk_percent?.toFixed?.(1) || '--'}</b>%</div>
          <div class="meta muted">Dernier: ${lastSeen} (${entry.client || ''})${expired ? ' ‚ö†Ô∏è' : ''}</div>
        `;
        fleetCards.appendChild(card);
      });
    }

    function applyFilterSortAndRender() {
      let data = (fleetRawData || []).slice();
      const statusFilter = filterStatus?.value || 'all';
      if (statusFilter !== 'all') {
        data = data.filter((entry) => {
          const st = (entry.report?.health?.status) || 'ok';
          const now = Date.now() / 1000;
          const isExpired = (now - entry.ts > fleetTTL);
          if (statusFilter === 'expired') return isExpired;
          return st === statusFilter && !isExpired;
        });
      }

      const sortVal = sortBy?.value || 'score_desc';
      data.sort((a, b) => {
        const ha = a.report?.health?.score || 0;
        const hb = b.report?.health?.score || 0;
        const ta = a.ts || 0;
        const tb = b.ts || 0;
        switch (sortVal) {
          case 'score_asc': return ha - hb;
          case 'last_desc': return tb - ta;
          case 'last_asc': return ta - tb;
          case 'score_desc':
          default: return hb - ha;
        }
      });

      document.getElementById('fleet-meta').textContent = `${data.length || 0} machines`;
      renderFleet(data || []);
    }

    function scheduleNext(delay) {
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshTimer = setTimeout(refreshFleet, delay);
    }

    function refreshFleet() {
      if (loading) return; // √©vite les appels concurrents
      loading = true;
      const meta = document.getElementById('fleet-meta');
      if (meta) meta.textContent = 'Chargement...';
      renderSkeleton(4);
      authFetch('/api/fleet')
        .then((resp) => resp.json())
        .then((data) => {
          errorStreak = 0;
          fleetRawData = data.data || [];
          applyFilterSortAndRender();
          if (meta) meta.textContent = `${fleetRawData.length} machines`;
          const errBox = document.getElementById('fleet-error');
          if (errBox) errBox.style.display = 'none';
          scheduleNext(refreshBaseMs);
        })
        .catch((err) => {
          console.error(err);
          errorStreak += 1;
          if (meta) meta.textContent = 'Erreur API';
          showToast('Erreur de r√©cup√©ration de la flotte', 'error');
          const errBox = document.getElementById('fleet-error');
          if (errBox) {
            errBox.textContent = 'Erreur API. Nouvelle tentative...';
            errBox.style.display = 'block';
          }
          const backoff = Math.min(refreshBaseMs * Math.pow(2, errorStreak), 30000);
          scheduleNext(backoff);
        })
        .finally(() => { loading = false; });
    }

    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) {
        langSelect.value = lang;
      }
      applyStaticTexts();
      refreshFleet();
    });

    if (filterStatus) filterStatus.addEventListener('change', applyFilterSortAndRender);
    if (sortBy) sortBy.addEventListener('change', applyFilterSortAndRender);

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    setTheme(theme);
    refreshFleet();
    startAutoRefresh();
  </script>
</body>
</html>
