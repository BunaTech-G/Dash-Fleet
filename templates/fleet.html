<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fleet - Tableau de bord système</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/i18n.js"></script>
</head>
<body>
  <main class="page">
    <header>
      <div>
        <p class="eyebrow" id="fleet-eyebrow">Fleet</p>
        <h1 id="fleet-title">Santé des postes</h1>
        <p class="lede" id="fleet-subtitle">Vue centrale des machines reportées par les agents.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle">Mode sombre</button>
      </div>
    </header>

    <nav class="nav-links">
      <a href="/" id="nav-live">Temps réel</a>
      <a href="/history" id="nav-history">Historique</a>
      <a href="/fleet" class="active" id="nav-fleet">Fleet</a>
    </nav>

    <section class="table-wrap">
      <div class="table-header">
        <h2 id="fleet-table-title">Machines</h2>
        <span class="muted" id="fleet-meta">--</span>
      </div>
      <div class="fleet-controls">
        <label>Statut:
          <select id="filter-status" class="control-select">
            <option value="all">Tous</option>
            <option value="ok">OK</option>
            <option value="warn">Warn</option>
            <option value="critical">Critical</option>
            <option value="expired">Expired</option>
          </select>
        </label>
        <label>Trier:
          <select id="sort-by" class="control-select">
            <option value="score_desc">Score (desc)</option>
            <option value="score_asc">Score (asc)</option>
            <option value="last_desc">Dernier (récent)</option>
            <option value="last_asc">Dernier (ancien)</option>
          </select>
        </label>
      </div>
      <div class="table-fleet" id="fleet-cards"></div>
    </section>

    <div class="empty" id="empty-state" hidden>
      <p id="empty-title">Aucune machine reportée.</p>
      <p class="muted" id="empty-hint">Déployer un agent qui POST sur /api/fleet/report avec FLEET_TOKEN.</p>
    </div>
  </main>

  <script>
    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    const fleetCards = document.getElementById('fleet-cards');
    const filterStatus = document.getElementById('filter-status');
    const sortBy = document.getElementById('sort-by');
    const fleetTTL = parseInt('{{ fleet_ttl_seconds }}', 10) || 600;
    let fleetRawData = [];
    let t = dashboardI18n.get();
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
    }

    function applyStaticTexts() {
      document.getElementById('lang-label').textContent = t.langLabel;
      document.getElementById('nav-live').textContent = t.navLive;
      document.getElementById('nav-history').textContent = t.navHistory;
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';

      document.getElementById('fleet-eyebrow').textContent = t.fleetEyebrow || 'Fleet';
      document.getElementById('fleet-title').textContent = t.fleetTitle || 'Santé des postes';
      document.getElementById('fleet-subtitle').textContent = t.fleetSubtitle || 'Vue centrale des machines reportées par les agents.';
      document.getElementById('fleet-table-title').textContent = t.fleetTableTitle || 'Machines';
      document.getElementById('empty-title').textContent = t.fleetEmptyTitle || 'Aucune machine reportée.';
      document.getElementById('empty-hint').textContent = t.fleetEmptyHint || 'Déployer un agent qui POST sur /api/fleet/report avec FLEET_TOKEN.';
      updateThemeButton();
    }


    function statusClass(status, lastSeenTs) {
      const now = Date.now() / 1000;
      if (status === 'critical') return 'status-critical';
      if (now - lastSeenTs > 600) return 'status-expired';
      if (status === 'warn') return 'status-warn';
      return 'status-ok';
    }

    function renderFleet(data) {
      fleetCards.innerHTML = '';
      if (!data.length) {
        document.getElementById('empty-state').hidden = false;
        return;
      }
      document.getElementById('empty-state').hidden = true;

      data.forEach((entry) => {
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const lastSeen = new Date(entry.ts * 1000).toISOString();
        const now = Date.now() / 1000;
        const expired = (now - entry.ts > fleetTTL);
        const card = document.createElement('article');
        card.className = `card ${statusClass(health.status, entry.ts)}`;
        card.innerHTML = `
          <div class="label">${entry.id || 'machine'}</div>
          <div class="value">${health.score || 0}/100</div>
          <div class="meta">${health.status || 'ok'} · ${report.uptime_hms || ''}</div>
          <div class="meta">CPU ${report.cpu_percent?.toFixed?.(1) || '--'}% · RAM ${report.ram_percent?.toFixed?.(1) || '--'}% · Disk ${report.disk_percent?.toFixed?.(1) || '--'}%</div>
          <div class="meta muted">Last: ${lastSeen} (${entry.client || ''})${expired ? ' ⚠️' : ''}</div>
        `;
        fleetCards.appendChild(card);
      });
    }

    function applyFilterSortAndRender() {
      let data = (fleetRawData || []).slice();
      const statusFilter = filterStatus?.value || 'all';
      if (statusFilter !== 'all') {
        data = data.filter((entry) => {
          const st = (entry.report?.health?.status) || 'ok';
          const now = Date.now() / 1000;
          const isExpired = (now - entry.ts > fleetTTL);
          if (statusFilter === 'expired') return isExpired;
          return st === statusFilter && !isExpired;
        });
      }

      const sortVal = sortBy?.value || 'score_desc';
      data.sort((a, b) => {
        const ha = a.report?.health?.score || 0;
        const hb = b.report?.health?.score || 0;
        const ta = a.ts || 0;
        const tb = b.ts || 0;
        switch (sortVal) {
          case 'score_asc': return ha - hb;
          case 'last_desc': return tb - ta;
          case 'last_asc': return ta - tb;
          case 'score_desc':
          default: return hb - ha;
        }
      });

      document.getElementById('fleet-meta').textContent = `${data.length || 0} machines`;
      renderFleet(data || []);
    }

    function refreshFleet() {
      fetch('/api/fleet')
        .then((resp) => resp.json())
        .then((data) => {
          fleetRawData = data.data || [];
          applyFilterSortAndRender();
        })
        .catch((err) => console.error(err));
    }

    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) {
        langSelect.value = lang;
      }
      applyStaticTexts();
      refreshFleet();
    });

    if (filterStatus) filterStatus.addEventListener('change', applyFilterSortAndRender);
    if (sortBy) sortBy.addEventListener('change', applyFilterSortAndRender);

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    setTheme(theme);
    refreshFleet();
    setInterval(refreshFleet, 5000);
  </script>
</body>
</html>
