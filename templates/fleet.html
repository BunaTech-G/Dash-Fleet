<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fleet - Sant√© des postes</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/i18n.js"></script>
</head>
<body>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <main class="page">
    <!-- ===== HEADER ===== -->
    <header>
      <div>
        <p class="eyebrow" id="fleet-eyebrow">Fleet</p>
        <h1 id="fleet-title">Sant√© des postes</h1>
        <p class="lede" id="fleet-subtitle">Vue centrale des machines report√©es par les agents.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le th√®me clair/sombre" tabindex="1">Mode sombre</button>
      </div>
    </header>

    <!-- ===== NAVIGATION ===== -->
    <nav class="nav-links">
      <a href="/" id="nav-live">Temps r√©el</a>
      <a href="/history" id="nav-history">Historique</a>
      <a href="/fleet" class="active" id="nav-fleet">Fleet</a>
      <a href="/help" id="nav-help">Aide</a>
    </nav>

    <!-- ===== FLEET SECTION ===== -->
    <section class="table-wrap">
      <div class="table-header">
        <h2 id="fleet-title-section">Machines</h2>
        <span class="muted" id="fleet-meta">-</span>
      </div>

      <!-- Installation Guide Banner -->
      <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; font-size: 13px; line-height: 1.6;">
        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 18px; line-height: 1;">üì¶</span>
          <div>
            <strong id="install-title">Installation Agent DashFleet</strong>
            <p class="muted" style="margin: 4px 0 0 0;" id="install-hint">D√©ployez rapidement sur Windows/Linux avec ces commandes one-liner :</p>
          </div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
          <button class="install-btn" onclick="copyToClipboard('windows-install')" data-os="windows" style="background: #0078d4; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
            üìç Windows (copier)
          </button>
          <button class="install-btn" onclick="copyToClipboard('linux-install')" data-os="linux" style="background: #FCC624; color: #000; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
            üêß Linux/Kali (copier)
          </button>
          <button class="install-btn" onclick="showInstallGuide()" style="background: var(--accent); color: #04263a; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
            ‚ùì Guide complet
          </button>
        </div>
        <!-- Hidden installation commands -->
        <pre id="windows-install" style="display: none;">Invoke-WebRequest -Uri "https://raw.githubusercontent.com/BunaTech-G/Dash-Fleet/fix/pyproject-exclude/deploy/install_dashfleet_oneliner.ps1" -OutFile "$env:TEMP\install.ps1"; & "$env:TEMP\install.ps1" -ApiKey "d2f6f9a8-3c7e-4c1f-9b0f-123456789abc"</pre>
        <pre id="linux-install" style="display: none;">curl -sSL https://raw.githubusercontent.com/BunaTech-G/Dash-Fleet/fix/pyproject-exclude/deploy/install_dashfleet_linux_oneliner.sh | sudo bash -s -- -k d2f6f9a8-3c7e-4c1f-9b0f-123456789abc</pre>
      </div>

      <!-- Status Legend -->
      <div class="legend-status" style="margin-bottom: 12px; font-size: 13px; color: var(--muted); display: flex; gap: 18px; flex-wrap: wrap; align-items: center;">
        <span><span class="dot dot-ok"></span> OK (Score ‚â•80)</span>
        <span><span class="dot dot-warn"></span> Avertissement (60-79)</span>
        <span><span class="dot dot-critical"></span> Critique (&lt;60)</span>
        <span><span class="dot dot-expired"></span> Expir√© (&gt;24h)</span>
      </div>

      <!-- Fleet Toolbar (Phase 6) -->
      <div class="fleet-toolbar" style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
        <button id="btn-refresh" onclick="refreshFleetManual()" title="Refresh fleet data" style="padding: 8px 12px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
          üîÑ Rafra√Æchir
        </button>
        <button id="btn-export" onclick="exportFleetCSV()" title="Export to CSV" style="padding: 8px 12px; background: var(--panel-strong); border: 1px solid var(--border); color: var(--text); border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
          üì• Exporter CSV
        </button>
        <span id="fleet-stats" style="margin-left: auto; font-size: 12px; color: var(--muted); white-space: nowrap;">-</span>
      </div>

      <!-- Error Box -->
      <div id="fleet-error" class="inline-error" role="status" aria-live="polite" style="display: none;"></div>

      <!-- Fleet Controls -->
      <div class="fleet-controls">
        <label id="label-filter">Statut:
          <select id="filter-status" class="control-select">
            <option value="all">Tous</option>
            <option value="ok">OK</option>
            <option value="warn">Avertissement</option>
            <option value="critical">Critique</option>
            <option value="expired">Expir√©</option>
          </select>
        </label>
        <label id="label-sort">Trier par:
          <select id="sort-by" class="control-select">
            <option value="score_desc">Score (d√©croissant)</option>
            <option value="score_asc">Score (croissant)</option>
            <option value="last_desc">Dernier (r√©cent)</option>
            <option value="last_asc">Dernier (ancien)</option>
          </select>
        </label>
      </div>

      <!-- Fleet Cards Grid -->
      <div class="table-fleet" id="fleet-cards" aria-label="Liste des machines" tabindex="2"></div>

      <!-- Empty State -->
      <div class="empty" id="empty-state" hidden>
        <p id="empty-title">Aucune machine report√©e.</p>
        <p class="muted" id="empty-hint">D√©ployez un agent avec les commandes ci-dessus (section Installation Agent).</p>
      </div>
    </section>

    <!-- ===== ACTION MODAL (Phase 4) ===== -->
    <div id="action-modal" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1000;">
      <div class="modal-content" style="background: var(--panel, #fff); border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow: auto;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border, #ccc);">
          <h3 id="action-modal-title" style="margin: 0; font-size: 18px; color: var(--text);">Actions pour la machine</h3>
          <button class="modal-close" onclick="closeActionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">√ó</button>
        </div>
        
        <div class="modal-body" style="padding: 16px;">
          <div class="form-group" style="margin-bottom: 12px;">
            <label for="action-type" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: var(--text);">Type d'action:</label>
            <select id="action-type" onchange="updateActionForm()" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--panel-strong); color: var(--text); font-family: inherit; cursor: pointer;">
              <option value="message">üí¨ Envoyer un message</option>
              <option value="restart">üîÑ Red√©marrer l'agent</option>
              <option value="reboot">üîå Red√©marrer la machine</option>
            </select>
          </div>
          
          <div id="message-form" class="form-group" style="display:none; margin-bottom: 12px;">
            <label for="action-message" style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: var(--text);">Message:</label>
            <textarea id="action-message" placeholder="Entrez votre message ici..." rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--panel-strong); color: var(--text); font-family: inherit;"></textarea>
          </div>
          
          <div id="reboot-warning" class="alert" style="display:none; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404; font-size: 13px;">
            ‚ö†Ô∏è Attention: Cela va red√©marrer la machine!
          </div>
        </div>
        
        <div class="modal-footer" style="display: flex; gap: 8px; padding: 16px; border-top: 1px solid var(--border);">
          <button class="btn-primary" onclick="sendAction()" style="flex: 1; padding: 10px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 200ms;">‚úì Envoyer</button>
          <button class="btn-secondary" onclick="closeActionModal()" style="flex: 1; padding: 10px; background: var(--panel-strong); border: 1px solid var(--border); color: var(--text); border-radius: 6px; cursor: pointer; font-weight: 600;">Annuler</button>
        </div>
      </div>
    </div>
  </main>

  <script src="/static/fleet-auth.js"></script>
  <script>
    // ===== LOAD CONFIG FROM SERVER =====
    let FLEET_TTL = 86400;  // Default fallback (24 hours)
    let REFRESH_INTERVAL = 5000;  // Default fallback (5 seconds)

    fetch('/api/config')
      .then(r => r.json())
      .then(config => {
        FLEET_TTL = config.FLEET_TTL_SECONDS;
        REFRESH_INTERVAL = config.REFRESH_INTERVAL_MS;
        console.log(`Fleet TTL: ${FLEET_TTL}s, Refresh: ${REFRESH_INTERVAL}ms`);
      })
      .catch(err => {
        console.warn('Could not load config, using defaults', err);
      });

    // ===== CONFIGURATION =====
    const SKELETON_COUNT = 4;

    // ===== DOM ELEMENTS =====
    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    const fleetCards = document.getElementById('fleet-cards');
    const filterStatus = document.getElementById('filter-status');
    const sortBy = document.getElementById('sort-by');
    const fleetMeta = document.getElementById('fleet-meta');
    const emptyState = document.getElementById('empty-state');
    const fleetError = document.getElementById('fleet-error');

    // ===== STATE =====
    let fleetRawData = [];
    let loading = false;
    let refreshTimer = null;
    let errorStreak = 0;
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';
    let t = dashboardI18n.get();

    // ===== UTILITIES =====
    function showToast(msg, type = 'info', duration = 3200) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.style.background = type === 'error' ? '#f43f5e' : (type === 'success' ? '#22c55e' : 'var(--accent)');
      toast.style.color = type === 'error' ? '#fff' : '#04263a';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, duration);
    }

    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const text = element.textContent || element.innerText;
      navigator.clipboard.writeText(text).then(() => {
        showToast('‚úÖ Commande copi√©e!', 'success');
      }).catch(() => {
        showToast('‚ùå Erreur de copie', 'error');
      });
    }

    // Phase 6 new functions
    function copyToClipboardFn(text) {
      navigator.clipboard.writeText(text)
        .then(() => showToast(`‚úÖ Copi√©: ${text}`, 'success', 2000))
        .catch(() => showToast('‚ùå Erreur de copie', 'error'));
    }

    function toggleDetails(detailsId) {
      const details = document.getElementById(detailsId);
      if (details) {
        const isHidden = details.style.display === 'none';
        details.style.display = isHidden ? 'block' : 'none';
        
        // Update button icon
        const btn = details.previousElementSibling;
        if (btn && btn.classList.contains('expand-btn')) {
          btn.textContent = isHidden ? '‚ñ≤ D√©tails syst√®me' : '‚ñº D√©tails syst√®me';
        }
      }
    }

    function exportFleetCSV() {
      if (!fleetRawData || fleetRawData.length === 0) {
        showToast('Aucune machine √† exporter', 'error');
        return;
      }

      const headers = ["Machine ID", "Health Score", "Status", "CPU%", "RAM%", "Disk%", "Uptime", "Dernier rapport"];
      const rows = fleetRawData.map(entry => {
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const now = Date.now() / 1000;
        const expired = (now - entry.ts > FLEET_TTL);
        const status = expired ? 'EXPIRED' : (health.status || 'ok').toUpperCase();
        
        return [
          entry.id || '',
          health.score || 0,
          status,
          report.cpu_percent?.toFixed?.(1) || '--',
          report.ram_percent?.toFixed?.(1) || '--',
          report.disk_percent?.toFixed?.(1) || '--',
          report.uptime_hms || '--',
          new Date(entry.ts * 1000).toLocaleString()
        ];
      });

      const csv = [
        headers.join(','),
        ...rows.map(r => r.map(v => `"${v}"`).join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `fleet-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showToast(`‚úÖ Exported ${fleetRawData.length} machines`, 'success');
    }

    function refreshFleetManual() {
      showToast('Rafra√Æchissement en cours...', 'info');
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshFleet();
    }

    function showInstallGuide() {
      const os = navigator.platform.toLowerCase().includes('win') ? 'Windows' : 'Linux';
      alert(`Installation Agent DashFleet - ${os}\n\nConsultez:\nhttps://github.com/BunaTech-G/Dash-Fleet/blob/fix/pyproject-exclude/deploy/INSTALL_QUICK_START.md\n\nOu pour Linux:\nhttps://github.com/BunaTech-G/Dash-Fleet/blob/fix/pyproject-exclude/deploy/INSTALL_QUICK_START_LINUX.md`);
    }

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
    }

    function applyStaticTexts() {
      document.getElementById('fleet-eyebrow').textContent = t.navFleet || 'Fleet';
      document.getElementById('fleet-title').textContent = t.fleetTitle || 'Sant√© des postes';
      document.getElementById('fleet-subtitle').textContent = t.fleetSubtitle || 'Vue centrale des machines report√©es par les agents.';
      document.getElementById('lang-label').textContent = t.langLabel || 'Langue';
      document.getElementById('nav-live').textContent = t.navLive || 'Temps r√©el';
      document.getElementById('nav-history').textContent = t.navHistory || 'Historique';
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';
      document.getElementById('nav-help').textContent = t.navHelp || 'Aide';
      document.getElementById('fleet-title-section').textContent = t.machinesTitle || 'Machines';
      document.getElementById('label-filter').textContent = t.filterLabel || 'Statut:';
      document.getElementById('label-sort').textContent = t.sortLabel || 'Trier par:';
      document.getElementById('empty-title').textContent = t.emptyFleet || 'Aucune machine report√©e.';
      document.getElementById('empty-hint').textContent = t.emptyFleetHint || 'D√©ployez un agent avec les commandes ci-dessus (section Installation Agent).';
      document.getElementById('install-title').textContent = t.installTitle || 'Installation Agent DashFleet';
      document.getElementById('install-hint').textContent = t.installHint || 'D√©ployez rapidement sur Windows/Linux avec ces commandes one-liner :';
      updateThemeButton();
    }

    function getStatusClass(status, lastSeenTs) {
      const now = Date.now() / 1000;
      if (now - lastSeenTs > FLEET_TTL) return 'status-expired';
      if (status === 'critical') return 'status-critical';
      if (status === 'warn') return 'status-warn';
      return 'status-ok';
    }

    function renderSkeleton(count = SKELETON_COUNT) {
      fleetCards.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const card = document.createElement('article');
        card.className = 'skeleton fade-in';
        card.style.animationDelay = (i * 0.06) + 's';
        card.innerHTML = `
          <div class="skeleton-line wide"></div>
          <div class="skeleton-line mid"></div>
          <div class="skeleton-line short"></div>
        `;
        fleetCards.appendChild(card);
      }
    }

    function renderFleet(data) {
      if (!data || data.length === 0) {
        fleetCards.innerHTML = '';
        emptyState.hidden = false;
        fleetMeta.textContent = '0 machines';
        return;
      }

      emptyState.hidden = true;
      fleetMeta.textContent = `${data.length} machine${data.length !== 1 ? 's' : ''} ¬∑ TTL 24h`;

      // Build a map of existing cards
      const existingCards = {};
      document.querySelectorAll('[data-machine-id]').forEach(card => {
        existingCards[card.dataset.machineId] = card;
      });

      // Track which machines are being rendered
      const renderedMachines = new Set();

      data.forEach((entry, i) => {
        renderedMachines.add(entry.id);
        const machineId = entry.id || 'machine';
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const now = Date.now() / 1000;
        const ageSeconds = now - entry.ts;
        const isOffline = entry.offline === true;
        const expired = isOffline || (ageSeconds > FLEET_TTL);
        const status = isOffline ? 'offline' : (expired ? 'expired' : (health.status || 'ok'));
        const lastSeen = new Date(entry.ts * 1000).toLocaleString();
        
        // Calculate time remaining before expiration or show offline duration
        const timeRemaining = Math.max(0, FLEET_TTL - ageSeconds);
        const offlineDuration = entry.offline_duration || 0;
        const hoursRemaining = Math.floor(timeRemaining / 3600);
        const minutesRemaining = Math.floor((timeRemaining % 3600) / 60);
        const hoursOffline = Math.floor(offlineDuration / 3600);
        const minutesOffline = Math.floor((offlineDuration % 3600) / 60);
        const expiresIn = isOffline 
          ? (hoursOffline > 0 ? `√âteint depuis ${hoursOffline}h ${minutesOffline}m` : `√âteint depuis ${minutesOffline}m`)
          : (hoursRemaining > 0 ? `${hoursRemaining}h ${minutesRemaining}m` : `${minutesRemaining}m`);

        const cpu = report.cpu_percent?.toFixed?.(1) || '--';
        const ram = report.ram_percent?.toFixed?.(1) || '--';
        const disk = report.disk_percent?.toFixed?.(1) || '--';
        const uptime = report.uptime_hms || '--';
        const score = health.score || 0;

        // Prepare system info for details panel
        const sysInfo = report.system || {};
        const osDisplay = `${sysInfo.os || 'N/A'} ${sysInfo.os_version || ''}`.trim();
        const pythonVersion = sysInfo.python_version || 'N/A';
        const architecture = sysInfo.architecture || 'N/A';
        const hardwareId = sysInfo.hardware_id || 'N/A';

        const detailsId = `details-${machineId.replace(/[^a-zA-Z0-9]/g, '-')}`;

        const newHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div class="label" title="${machineId}" style="flex: 1; min-width: 120px;">üñ•Ô∏è ${machineId}</div>
            <button class="copy-btn" onclick="copyToClipboardFn('${machineId}')" title="Copy machine ID" style="padding: 4px 8px; background: var(--panel-strong); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; font-size: 11px; color: var(--muted);">üìã</button>
            <span class="badge badge-score badge-${status}">${score}/100</span>
          </div>
          <div class="meta" style="margin-bottom: 4px;">
            <span class="dot dot-${status}"></span> ${isOffline ? 'üî¥ √âTEINT' : status.toUpperCase()} ¬∑ Uptime: ${uptime}
          </div>
          <div class="meta">
            CPU <b>${cpu}%</b> ¬∑ RAM <b>${ram}%</b> ¬∑ Disk <b>${disk}%</b>
          </div>
          <div class="meta muted">
            Dernier rapport: ${lastSeen}${isOffline ? ` ¬∑ ${expiresIn}` : (expired ? ' ‚ö†Ô∏è EXPIR√â' : ` (${expiresIn} restant)`)}
          </div>
          <button class="expand-btn" onclick="toggleDetails('${detailsId}')" style="width: 100%; padding: 6px; margin-top: 8px; background: var(--panel-strong); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 11px; color: var(--muted); transition: all 200ms;">
            ‚ñº D√©tails syst√®me
          </button>
          <div id="${detailsId}" class="machine-details" style="display: none; width: 100%; margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.15); border-radius: 4px; border-left: 3px solid var(--accent); font-size: 11px; font-family: 'Courier New', monospace;">
            <div style="margin: 2px 0;"><strong>OS:</strong> ${osDisplay}</div>
            <div style="margin: 2px 0;"><strong>Architecture:</strong> ${architecture}</div>
            <div style="margin: 2px 0;"><strong>Python:</strong> ${pythonVersion}</div>
            <div style="margin: 2px 0; word-break: break-all;"><strong>Hardware ID:</strong> <code>${hardwareId}</code></div>
          </div>
          <div class="card-actions" style="margin-top: 12px; display: flex; gap: 8px;">
            <button class="action-btn" onclick="showActionModal('${machineId}', '${machineId}')" title="Envoyer un message ou une commande" style="flex: 1; padding: 10px 14px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 200ms; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);">
              üí¨ Envoyer Message
            </button>
          </div>
        `;

        if (existingCards[machineId]) {
          // Update existing card (don't recreate)
          const card = existingCards[machineId];
          const oldStatus = card.className.split(' ').find(c => c.startsWith('status-'));
          const newStatus = getStatusClass(status, entry.ts);
          
          if (oldStatus !== newStatus) {
            card.className = card.className.replace(oldStatus, newStatus);
          }
          card.innerHTML = newHTML;
        } else {
          // Create new card
          const card = document.createElement('article');
          card.className = `card ${getStatusClass(status, entry.ts)} fade-in`;
          card.style.animationDelay = (i * 0.07) + 's';
          card.setAttribute('aria-label', `Machine ${machineId}`);
          card.setAttribute('data-machine-id', machineId);
          card.setAttribute('tabindex', 3 + i);
          card.innerHTML = newHTML;
          fleetCards.appendChild(card);
        }
      });

      // Remove machines that are no longer in the data
      Object.keys(existingCards).forEach(machineId => {
        if (!renderedMachines.has(machineId)) {
          existingCards[machineId].remove();
        }
      });
    }

    function applyFilterSortAndRender() {
      let data = (fleetRawData || []).slice();

      // Filter by status
      const statusFilter = filterStatus?.value || 'all';
      if (statusFilter !== 'all') {
        data = data.filter((entry) => {
          const st = (entry.report?.health?.status) || 'ok';
          const now = Date.now() / 1000;
          const isExpired = (now - entry.ts > FLEET_TTL);
          if (statusFilter === 'expired') return isExpired;
          return st === statusFilter && !isExpired;
        });
      }

      // Sort
      const sortVal = sortBy?.value || 'score_desc';
      data.sort((a, b) => {
        const ha = a.report?.health?.score || 0;
        const hb = b.report?.health?.score || 0;
        const ta = a.ts || 0;
        const tb = b.ts || 0;
        switch (sortVal) {
          case 'score_asc': return ha - hb;
          case 'last_desc': return tb - ta;
          case 'last_asc': return ta - tb;
          case 'score_desc':
          default: return hb - ha;
        }
      });

      renderFleet(data);
    }

    function scheduleRefresh(delay = REFRESH_INTERVAL) {
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshTimer = setTimeout(refreshFleet, delay);
    }

    function refreshFleet() {
      if (loading) return;
      loading = true;

      fleetMeta.textContent = 'Chargement...';
      renderSkeleton();

      fetch('/api/fleet/public')
        .then((resp) => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then((data) => {
          errorStreak = 0;
          fleetRawData = data.data || [];
          applyFilterSortAndRender();
          if (fleetError) fleetError.style.display = 'none';
          scheduleRefresh();
        })
        .catch((err) => {
          console.error('Fleet error:', err);
          errorStreak += 1;
          fleetMeta.textContent = 'Erreur API';

          if (fleetError) {
            fleetError.textContent = `Erreur de connexion. Nouvelle tentative dans ${Math.ceil(Math.min(REFRESH_INTERVAL * Math.pow(2, errorStreak), 30000) / 1000)}s...`;
            fleetError.style.display = 'block';
          }

          showToast('Erreur de r√©cup√©ration de la flotte', 'error');

          const backoff = Math.min(REFRESH_INTERVAL * Math.pow(2, errorStreak), 30000);
          scheduleRefresh(backoff);
        })
        .finally(() => {
          loading = false;
        });
    }

    // ===== EVENT LISTENERS =====
    if (filterStatus) filterStatus.addEventListener('change', applyFilterSortAndRender);
    if (sortBy) sortBy.addEventListener('change', applyFilterSortAndRender);

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    // Phase 6: Keyboard navigation for accessibility
    document.addEventListener('keydown', (e) => {
      // Escape key closes modal
      if (e.key === 'Escape') {
        const modal = document.getElementById('action-modal');
        if (modal && modal.style.display === 'flex') {
          closeActionModal();
        }
      }
    });

    // ===== ACTION MODAL FUNCTIONS (Phase 4) =====
    let currentMachineId = null;

    function showActionModal(machineId, machineName) {
      currentMachineId = machineId;
      document.getElementById('action-modal-title').textContent = `Actions for ${machineName}`;
      document.getElementById('action-modal').style.display = 'flex';
      updateActionForm();
    }

    function closeActionModal() {
      document.getElementById('action-modal').style.display = 'none';
      currentMachineId = null;
    }

    function updateActionForm() {
      const actionType = document.getElementById('action-type').value;
      document.getElementById('message-form').style.display = 
        actionType === 'message' ? 'block' : 'none';
      document.getElementById('reboot-warning').style.display = 
        actionType === 'reboot' ? 'block' : 'none';
    }

    function sendAction() {
      const machineId = currentMachineId;
      const actionType = document.getElementById('action-type').value;
      
      const data = {
        machine_id: machineId,
        action_type: actionType,
        data: {}
      };
      
      if (actionType === 'message') {
        data.data.message = document.getElementById('action-message').value;
        data.data.title = 'DashFleet';
        if (!data.data.message) {
          showToast('Please enter a message', 'error');
          return;
        }
      }
      
      // Get auth token
      const authHeader = document.querySelector('script[src="/static/fleet-auth.js"]');
      const token = localStorage.getItem('auth_token') || '';
      
      fetch('/api/actions/queue', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(d => {
        if (d.ok || d.action_id) {
          showToast(`Action sent to ${machineId}!`, 'success');
          closeActionModal();
        } else {
          showToast('Error: ' + (d.error || 'Unknown error'), 'error');
        }
      })
      .catch(e => showToast('Error: ' + e, 'error'));
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('action-modal');
      if (e.target === modal) {
        closeActionModal();
      }
    });

    // ===== INTERNATIONALIZATION =====
    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) langSelect.value = lang;
      applyStaticTexts();
    });

    // ===== INITIALIZATION =====
    setTheme(theme);
    applyStaticTexts();
    refreshFleet();
  </script>
</body>
</html>
