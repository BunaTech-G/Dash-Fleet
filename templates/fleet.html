<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fleet - Santé des postes</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/i18n.js"></script>
</head>
<body>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <main class="page">
    <!-- ===== HEADER ===== -->
    <header>
      <div>
        <p class="eyebrow" id="fleet-eyebrow">Fleet</p>
        <h1 id="fleet-title">Santé des postes</h1>
        <p class="lede" id="fleet-subtitle">Vue centrale des machines reportées par les agents.</p>
      </div>
      <div class="header-actions">
        <div class="lang-switch">
          <label for="lang-select" id="lang-label">Langue</label>
          <select id="lang-select" class="lang-select">
            <option value="fr">FR</option>
            <option value="en">EN</option>
            <option value="es">ES</option>
            <option value="ru">RU</option>
          </select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Changer le thème clair/sombre" tabindex="1">Mode sombre</button>
      </div>
    </header>

    <!-- ===== NAVIGATION ===== -->
    <nav class="nav-links">
      <a href="/" id="nav-live">Temps réel</a>
      <a href="/history" id="nav-history">Historique</a>
      <a href="/fleet" class="active" id="nav-fleet">Fleet</a>
      <a href="/help" id="nav-help">Aide</a>
    </nav>

    <!-- ===== FLEET SECTION ===== -->
    <section class="table-wrap">
      <div class="table-header">
        <h2 id="fleet-title-section">Machines</h2>
        <span class="muted" id="fleet-meta">-</span>
      </div>

      <!-- Status Legend -->
      <div class="legend-status" style="margin-bottom: 12px; font-size: 13px; color: var(--muted); display: flex; gap: 18px; flex-wrap: wrap; align-items: center;">
        <span><span class="dot dot-ok"></span> OK</span>
        <span><span class="dot dot-warn"></span> Avertissement</span>
        <span><span class="dot dot-critical"></span> Critique</span>
        <span><span class="dot dot-expired"></span> Expiré</span>
      </div>

      <!-- Error Box -->
      <div id="fleet-error" class="inline-error" role="status" aria-live="polite" style="display: none;"></div>

      <!-- Fleet Controls -->
      <div class="fleet-controls">
        <label id="label-filter">Statut:
          <select id="filter-status" class="control-select">
            <option value="all">Tous</option>
            <option value="ok">OK</option>
            <option value="warn">Avertissement</option>
            <option value="critical">Critique</option>
            <option value="expired">Expiré</option>
          </select>
        </label>
        <label id="label-sort">Trier par:
          <select id="sort-by" class="control-select">
            <option value="score_desc">Score (décroissant)</option>
            <option value="score_asc">Score (croissant)</option>
            <option value="last_desc">Dernier (récent)</option>
            <option value="last_asc">Dernier (ancien)</option>
          </select>
        </label>
      </div>

      <!-- Fleet Cards Grid -->
      <div class="table-fleet" id="fleet-cards" aria-label="Liste des machines" tabindex="2"></div>

      <!-- Empty State -->
      <div class="empty" id="empty-state" hidden>
        <p id="empty-title">Aucune machine reportée.</p>
        <p class="muted" id="empty-hint">Déployer un agent qui POST sur /api/fleet/report.</p>
      </div>
    </section>
  </main>

  <script src="/static/fleet-auth.js"></script>
  <script>
    // ===== CONFIGURATION =====
    const FLEET_TTL = 600; // 10 minutes
    const REFRESH_INTERVAL = 5000; // 5 secondes
    const SKELETON_COUNT = 4;

    // ===== DOM ELEMENTS =====
    const langSelect = document.getElementById('lang-select');
    const themeToggle = document.getElementById('theme-toggle');
    const fleetCards = document.getElementById('fleet-cards');
    const filterStatus = document.getElementById('filter-status');
    const sortBy = document.getElementById('sort-by');
    const fleetMeta = document.getElementById('fleet-meta');
    const emptyState = document.getElementById('empty-state');
    const fleetError = document.getElementById('fleet-error');

    // ===== STATE =====
    let fleetRawData = [];
    let loading = false;
    let refreshTimer = null;
    let errorStreak = 0;
    let theme = localStorage.getItem('theme') === 'light' ? 'light' : 'dark';
    let t = dashboardI18n.get();

    // ===== UTILITIES =====
    function showToast(msg, type = 'info', duration = 3200) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.style.background = type === 'error' ? '#f43f5e' : (type === 'success' ? '#22c55e' : 'var(--accent)');
      toast.style.color = type === 'error' ? '#fff' : '#04263a';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, duration);
    }

    function updateThemeButton() {
      if (!themeToggle) return;
      themeToggle.textContent = theme === 'dark' ? (t.themeLight || 'Mode clair') : (t.themeDark || 'Mode sombre');
    }

    function setTheme(nextTheme) {
      theme = nextTheme === 'light' ? 'light' : 'dark';
      document.body.classList.toggle('light', theme === 'light');
      localStorage.setItem('theme', theme);
      updateThemeButton();
    }

    function applyStaticTexts() {
      document.getElementById('fleet-eyebrow').textContent = t.navFleet || 'Fleet';
      document.getElementById('fleet-title').textContent = t.fleetTitle || 'Santé des postes';
      document.getElementById('fleet-subtitle').textContent = t.fleetSubtitle || 'Vue centrale des machines reportées par les agents.';
      document.getElementById('lang-label').textContent = t.langLabel || 'Langue';
      document.getElementById('nav-live').textContent = t.navLive || 'Temps réel';
      document.getElementById('nav-history').textContent = t.navHistory || 'Historique';
      document.getElementById('nav-fleet').textContent = t.navFleet || 'Fleet';
      document.getElementById('nav-help').textContent = t.navHelp || 'Aide';
      document.getElementById('fleet-title-section').textContent = t.machinesTitle || 'Machines';
      document.getElementById('label-filter').textContent = t.filterLabel || 'Statut:';
      document.getElementById('label-sort').textContent = t.sortLabel || 'Trier par:';
      document.getElementById('empty-title').textContent = t.emptyFleet || 'Aucune machine reportée.';
      document.getElementById('empty-hint').textContent = t.emptyFleetHint || 'Déployer un agent qui POST sur /api/fleet/report.';
      updateThemeButton();
    }

    function getStatusClass(status, lastSeenTs) {
      const now = Date.now() / 1000;
      if (now - lastSeenTs > FLEET_TTL) return 'status-expired';
      if (status === 'critical') return 'status-critical';
      if (status === 'warn') return 'status-warn';
      return 'status-ok';
    }

    function renderSkeleton(count = SKELETON_COUNT) {
      fleetCards.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const card = document.createElement('article');
        card.className = 'skeleton fade-in';
        card.style.animationDelay = (i * 0.06) + 's';
        card.innerHTML = `
          <div class="skeleton-line wide"></div>
          <div class="skeleton-line mid"></div>
          <div class="skeleton-line short"></div>
        `;
        fleetCards.appendChild(card);
      }
    }

    function renderFleet(data) {
      fleetCards.innerHTML = '';

      if (!data || data.length === 0) {
        emptyState.hidden = false;
        fleetMeta.textContent = '0 machines';
        return;
      }

      emptyState.hidden = true;
      fleetMeta.textContent = `${data.length} machine${data.length !== 1 ? 's' : ''}`;

      data.forEach((entry, i) => {
        const report = entry.report || {};
        const health = report.health || { score: 0, status: 'ok' };
        const now = Date.now() / 1000;
        const expired = (now - entry.ts > FLEET_TTL);
        const status = expired ? 'expired' : (health.status || 'ok');
        const lastSeen = new Date(entry.ts * 1000).toLocaleString();

        const card = document.createElement('article');
        card.className = `card ${getStatusClass(status, entry.ts)} fade-in`;
        card.style.animationDelay = (i * 0.07) + 's';
        card.setAttribute('aria-label', `Machine ${entry.id || 'machine'}`);
        card.setAttribute('tabindex', 3 + i);

        const cpu = report.cpu_percent?.toFixed?.(1) || '--';
        const ram = report.ram_percent?.toFixed?.(1) || '--';
        const disk = report.disk_percent?.toFixed?.(1) || '--';
        const uptime = report.uptime_hms || '--';
        const score = health.score || 0;

        card.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <div class="label">${entry.id || 'machine'}</div>
            <span class="badge badge-score badge-${status}">${score}/100</span>
          </div>
          <div class="meta" style="margin-bottom: 4px;">
            <span class="dot dot-${status}"></span> ${status.toUpperCase()} · ${uptime}
          </div>
          <div class="meta">
            CPU <b>${cpu}%</b> · RAM <b>${ram}%</b> · Disk <b>${disk}%</b>
          </div>
          <div class="meta muted">
            ${lastSeen}${expired ? ' ⚠️' : ''}
          </div>
        `;
        fleetCards.appendChild(card);
      });
    }

    function applyFilterSortAndRender() {
      let data = (fleetRawData || []).slice();

      // Filter by status
      const statusFilter = filterStatus?.value || 'all';
      if (statusFilter !== 'all') {
        data = data.filter((entry) => {
          const st = (entry.report?.health?.status) || 'ok';
          const now = Date.now() / 1000;
          const isExpired = (now - entry.ts > FLEET_TTL);
          if (statusFilter === 'expired') return isExpired;
          return st === statusFilter && !isExpired;
        });
      }

      // Sort
      const sortVal = sortBy?.value || 'score_desc';
      data.sort((a, b) => {
        const ha = a.report?.health?.score || 0;
        const hb = b.report?.health?.score || 0;
        const ta = a.ts || 0;
        const tb = b.ts || 0;
        switch (sortVal) {
          case 'score_asc': return ha - hb;
          case 'last_desc': return tb - ta;
          case 'last_asc': return ta - tb;
          case 'score_desc':
          default: return hb - ha;
        }
      });

      renderFleet(data);
    }

    function scheduleRefresh(delay = REFRESH_INTERVAL) {
      if (refreshTimer) clearTimeout(refreshTimer);
      refreshTimer = setTimeout(refreshFleet, delay);
    }

    function refreshFleet() {
      if (loading) return;
      loading = true;

      fleetMeta.textContent = 'Chargement...';
      renderSkeleton();

      authFetch('/api/fleet')
        .then((resp) => {
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          return resp.json();
        })
        .then((data) => {
          errorStreak = 0;
          fleetRawData = data.data || [];
          applyFilterSortAndRender();
          if (fleetError) fleetError.style.display = 'none';
          scheduleRefresh();
        })
        .catch((err) => {
          console.error('Fleet error:', err);
          errorStreak += 1;
          fleetMeta.textContent = 'Erreur API';

          if (fleetError) {
            fleetError.textContent = `Erreur de connexion. Nouvelle tentative dans ${Math.ceil(Math.min(REFRESH_INTERVAL * Math.pow(2, errorStreak), 30000) / 1000)}s...`;
            fleetError.style.display = 'block';
          }

          showToast('Erreur de récupération de la flotte', 'error');

          const backoff = Math.min(REFRESH_INTERVAL * Math.pow(2, errorStreak), 30000);
          scheduleRefresh(backoff);
        })
        .finally(() => {
          loading = false;
        });
    }

    // ===== EVENT LISTENERS =====
    if (filterStatus) filterStatus.addEventListener('change', applyFilterSortAndRender);
    if (sortBy) sortBy.addEventListener('change', applyFilterSortAndRender);

    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTheme(theme === 'dark' ? 'light' : 'dark');
      });
    }

    // ===== INTERNATIONALIZATION =====
    dashboardI18n.bindSelect(langSelect);
    dashboardI18n.subscribe((lang, nextT) => {
      t = nextT;
      if (langSelect) langSelect.value = lang;
      applyStaticTexts();
    });

    // ===== INITIALIZATION =====
    setTheme(theme);
    applyStaticTexts();
    refreshFleet();
  </script>
</body>
</html>
