<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion - DashFleet</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* Small overrides to centre the auth card */
    .auth-wrap { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding:40px; }
    .auth-card { width:420px; max-width:96%; padding:28px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--border); box-shadow:var(--shadow); }
    .auth-card h2 { margin:0 0 8px; font-size:22px }
    .auth-hint { color:var(--muted); margin-bottom:14px }
    .auth-field { margin-bottom:12px }
    .auth-input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background: rgba(255,255,255,0.02); color:var(--text); }
    .auth-btn { margin-top:8px; width:100%; padding:10px; border-radius:10px; border:none; background:var(--accent); color:#04263a; font-weight:700; cursor:pointer }
    .auth-error { margin-top:10px; color:#ffb4b4; font-weight:600 }
    .small { font-size:13px; color:var(--muted); margin-top:8px }
  </style>
</head>
<body class="">
  <div class="page auth-wrap">
    <div class="auth-card">
      <div class="header" style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <img src="/static/logo.svg" alt="DashFleet" style="height:40px;" />
        <div>
          <div class="eyebrow">Tableau de bord système</div>
          <h2 id="login-title">Connexion</h2>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <p id="login-hint" class="auth-hint">Entrez une clé API valide pour afficher le tableau de bord.</p>
        <select id="lang" class="lang-select" aria-label="Langue">
          <option value="fr">FR</option>
          <option value="en">EN</option>
        </select>
      </div>

      <div class="auth-field">
        <label for="api_key" class="label">Clé API</label>
        <input id="api_key" class="auth-input" type="text" placeholder="xxxx..." autocomplete="off" />
      </div>

      <button id="login" class="auth-btn">Se connecter</button>
      <div id="msg" class="auth-error" aria-live="polite"></div>
      <div class="small" id="login-footer">Vous pouvez créer une clé via l'admin si vous disposez d'un `ACTION_TOKEN`.</div>
          <div style="position: absolute; bottom: 18px; right: 24px; font-size: 12px; color: #888;">
            <a href="/setup-admin" style="color: #888; text-decoration: none;">Initialiser admin&nbsp;?</a>
          </div>
    </div>
  </div>

  <script>
    const i18n = {
      fr: {
        title: 'Connexion', hint: 'Entrez une clé API valide pour afficher le tableau de bord.',
        api_required: 'La clé API est requise.', network: 'Erreur réseau.', create_hint: "Vous pouvez créer une clé via l'admin si vous disposez d'un ACTION_TOKEN.", login_btn: 'Se connecter'
      },
      en: {
        title: 'Sign in', hint: 'Enter a valid API key to view the dashboard.',
        api_required: 'API key is required.', network: 'Network error.', create_hint: 'You can create a key via admin if you have an ACTION_TOKEN.', login_btn: 'Sign in'
      }
    };

    function applyLang(code){
      const t = i18n[code]||i18n.fr;
      document.getElementById('login-title').textContent = t.title;
      document.getElementById('login-hint').textContent = t.hint;
      document.getElementById('login-footer').textContent = t.create_hint;
      document.getElementById('login').textContent = t.login_btn;
      document.getElementById('msg').textContent = '';
      document.getElementById('api_key').placeholder = '';
      // store selected
      try{ localStorage.setItem('dash_lang', code) }catch(e){}
    }

    (function(){ const stored = localStorage.getItem('dash_lang')||'fr'; document.getElementById('lang').value=stored; applyLang(stored); })();

    document.getElementById('lang').addEventListener('change', (e)=> applyLang(e.target.value));

    async function doLogin() {
      const key = document.getElementById('api_key').value.trim();
      const msg = document.getElementById('msg');
      msg.textContent = '';
      const lang = document.getElementById('lang').value || 'fr';
      const t = i18n[lang] || i18n.fr;
      if (!key) { msg.textContent = t.api_required; return }
      try {
        const resp = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key })
        });
        const data = await resp.json();
        if (!resp.ok) {
          msg.textContent = data.error || t.network;
          return
        }
        // session cookie set by server; redirect to root
        window.location.replace('/');
      } catch (err) {
        msg.textContent = t.network;
      }
    }
    document.getElementById('login').addEventListener('click', doLogin);
    document.getElementById('api_key').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin() });
  </script>
</body>
</html>
